{
  "description": "Flow Solibra CAN 2025 - Optimis√© avec gestion erreurs et routage intelligent",
  "states": [
    {
      "name": "Trigger",
      "type": "trigger",
      "transitions": [
        {
          "next": "set_variables_initial",
          "event": "incomingMessage"
        },
        {
          "event": "incomingCall"
        },
        {
          "event": "incomingConversationMessage"
        },
        {
          "event": "incomingRequest"
        },
        {
          "event": "incomingParent"
        }
      ],
      "properties": {
        "offset": {
          "x": 0,
          "y": 0
        }
      }
    },
    {
      "name": "set_variables_initial",
      "type": "set-variables",
      "transitions": [
        {
          "next": "normalize_message",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "{{trigger.message.From}}",
            "key": "phone_number"
          },
          {
            "type": "string",
            "value": "{{trigger.message.Body}}",
            "key": "user_message"
          },
          {
            "type": "string",
            "value": "{{trigger.message.Body | upcase | strip}}",
            "key": "user_message_normalized"
          },
          {
            "type": "string",
            "value": "{{now | date: '%Y-%m-%d %H:%M:%S'}}",
            "key": "timestamp"
          },
          {
            "type": "number",
            "value": "0",
            "key": "retry_count"
          }
        ],
        "offset": {
          "x": 0,
          "y": 200
        }
      }
    },
    {
      "name": "normalize_message",
      "type": "set-variables",
      "transitions": [
        {
          "next": "check_global_stop",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "{{widgets.set_variables_initial.user_message_normalized | replace: ' ', '' | replace: '\n', ''}}",
            "key": "clean_message"
          }
        ],
        "offset": {
          "x": 0,
          "y": 400
        }
      }
    },
    {
      "name": "check_global_stop",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "http_check_user_status",
          "event": "noMatch"
        },
        {
          "next": "http_handle_stop",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "STOP demand√©",
              "arguments": [
                "{{flow.variables.clean_message}}"
              ],
              "type": "matches_any_of",
              "value": "STOP,ARRET,UNSUBSCRIBE"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{flow.variables.clean_message}}",
        "offset": {
          "x": 0,
          "y": 600
        }
      }
    },
    {
      "name": "http_check_user_status",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "parse_user_status",
          "event": "success"
        },
        {
          "next": "handle_api_error",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 0,
          "y": 850
        },
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\n  \"phone\": \"{{flow.variables.phone_number}}\"\n}",
        "url": "https://app-can-solibra.ywcdigital.com/api/can/check-user",
        "timeout": 10000
      }
    },
    {
      "name": "parse_user_status",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "detect_source_type",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Nouvel utilisateur",
              "arguments": [
                "{{widgets.http_check_user_status.parsed.status}}"
              ],
              "type": "equal_to",
              "value": "NOT_FOUND"
            }
          ]
        },
        {
          "next": "route_registered_user",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Utilisateur inscrit",
              "arguments": [
                "{{widgets.http_check_user_status.parsed.status}}"
              ],
              "type": "equal_to",
              "value": "INSCRIT"
            }
          ]
        },
        {
          "next": "handle_reactivation",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Utilisateur STOP",
              "arguments": [
                "{{widgets.http_check_user_status.parsed.status}}"
              ],
              "type": "equal_to",
              "value": "STOP"
            }
          ]
        },
        {
          "next": "handle_api_error",
          "event": "noMatch"
        }
      ],
      "properties": {
        "input": "{{widgets.http_check_user_status.parsed.status}}",
        "offset": {
          "x": 0,
          "y": 1100
        }
      }
    },
    {
      "name": "detect_source_type",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "set_source_direct",
          "event": "noMatch"
        },
        {
          "next": "set_source_affiche",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Source Affiche",
              "arguments": [
                "{{flow.variables.clean_message}}"
              ],
              "type": "matches_any_of",
              "value": "START_AFF_GOMBE,START_AFF_MASINA,START_AFF_LEMBA,START_AFF_BANDAL,START_AFF_NGALI,START_AFF_MATETE,START_AFF_KINTAMBO,START_AFF_NDJILI,START_AFF_LIMETE"
            }
          ]
        },
        {
          "next": "set_source_pdv",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Source PDV",
              "arguments": [
                "{{flow.variables.clean_message}}"
              ],
              "type": "matches_any_of",
              "value": "START_PDV_BRACONGO,START_PDV_BAR1,START_PDV_BAR2,START_PDV_DEPOT1,START_PDV_DEPOT2"
            }
          ]
        },
        {
          "next": "set_source_digital",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Source Digital",
              "arguments": [
                "{{flow.variables.clean_message}}"
              ],
              "type": "matches_any_of",
              "value": "START_FB,START_IG,START_TIKTOK,START_WA_STATUS,START_WEB"
            }
          ]
        },
        {
          "next": "set_source_flyer",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Source Flyer",
              "arguments": [
                "{{flow.variables.clean_message}}"
              ],
              "type": "matches_any_of",
              "value": "START_FLYER_UNI,START_FLYER_RUE,START_FLYER_EVENT"
            }
          ]
        },
        {
          "next": "set_source_radio",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Source Radio",
              "arguments": [
                "{{flow.variables.clean_message}}"
              ],
              "type": "matches_any_of",
              "value": "START_RADIO,START_RTGA,START_RTNC"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{flow.variables.clean_message}}",
        "offset": {
          "x": -800,
          "y": 1400
        }
      }
    },
    {
      "name": "set_source_affiche",
      "type": "set-variables",
      "transitions": [
        {
          "next": "start_registration_flow",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "AFFICHE",
            "key": "source_type"
          },
          {
            "type": "string",
            "value": "{{flow.variables.clean_message | replace: 'START_AFF_', ''}}",
            "key": "source_detail"
          }
        ],
        "offset": {
          "x": -1200,
          "y": 1700
        }
      }
    },
    {
      "name": "set_source_pdv",
      "type": "set-variables",
      "transitions": [
        {
          "next": "start_registration_flow",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "PDV_BRACONGO",
            "key": "source_type"
          },
          {
            "type": "string",
            "value": "{{flow.variables.clean_message | replace: 'START_PDV_', ''}}",
            "key": "source_detail"
          }
        ],
        "offset": {
          "x": -900,
          "y": 1700
        }
      }
    },
    {
      "name": "set_source_digital",
      "type": "set-variables",
      "transitions": [
        {
          "next": "start_registration_flow",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "DIGITAL",
            "key": "source_type"
          },
          {
            "type": "string",
            "value": "{{flow.variables.clean_message | replace: 'START_', ''}}",
            "key": "source_detail"
          }
        ],
        "offset": {
          "x": -600,
          "y": 1700
        }
      }
    },
    {
      "name": "set_source_flyer",
      "type": "set-variables",
      "transitions": [
        {
          "next": "start_registration_flow",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "FLYER",
            "key": "source_type"
          },
          {
            "type": "string",
            "value": "{{flow.variables.clean_message | replace: 'START_FLYER_', ''}}",
            "key": "source_detail"
          }
        ],
        "offset": {
          "x": -300,
          "y": 1700
        }
      }
    },
    {
      "name": "set_source_radio",
      "type": "set-variables",
      "transitions": [
        {
          "next": "start_registration_flow",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "RADIO",
            "key": "source_type"
          },
          {
            "type": "string",
            "value": "{{flow.variables.clean_message | replace: 'START_', '' | replace: 'RADIO_', ''}}",
            "key": "source_detail"
          }
        ],
        "offset": {
          "x": 0,
          "y": 1700
        }
      }
    },
    {
      "name": "set_source_direct",
      "type": "set-variables",
      "transitions": [
        {
          "next": "start_registration_flow",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "DIRECT",
            "key": "source_type"
          },
          {
            "type": "string",
            "value": "SANS_QR",
            "key": "source_detail"
          }
        ],
        "offset": {
          "x": 300,
          "y": 1700
        }
      }
    },
    {
      "name": "start_registration_flow",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "msg_welcome_registration",
          "event": "success"
        },
        {
          "next": "handle_api_error",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -600,
          "y": 2000
        },
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\n  \"phone\": \"{{flow.variables.phone_number}}\",\n  \"source_type\": \"{{flow.variables.source_type}}\",\n  \"source_detail\": \"{{flow.variables.source_detail}}\",\n  \"timestamp\": \"{{flow.variables.timestamp}}\",\n  \"status\": \"SCAN\"\n}",
        "url": "https://app-can-solibra.ywcdigital.com/api/can/scan",
        "timeout": 10000
      }
    },
    {
      "name": "msg_welcome_registration",
      "type": "send-and-wait-for-reply",
      "transitions": [
        {
          "next": "validate_optin_response",
          "event": "incomingMessage"
        },
        {
          "next": "handle_timeout",
          "event": "timeout"
        },
        {
          "next": "handle_delivery_failure",
          "event": "deliveryFailure"
        }
      ],
      "properties": {
        "offset": {
          "x": -600,
          "y": 2250
        },
        "from": "{{flow.channel.address}}",
        "body": "‚öΩ BabiFoot by Solibra 2025\n\nAkwaba supporter !\n\nSolibra t'invite dans ses Villages babifoot city √† Abidjan !\n\nüéÅ Jeux, cadeaux & surprises t'attendent !\n\n‚ö†Ô∏è Pour continuer, confirme :\n‚úÖ Tu as 18 ans ou plus\n‚úÖ Tu acceptes nos messages\n\nüëâ Tape OUI pour t'inscrire\nüëâ Tape NON pour refuser",
        "timeout": "3600"
      }
    },
    {
      "name": "validate_optin_response",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "http_log_optin",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "OUI accept√©",
              "arguments": [
                "{{widgets.msg_welcome_registration.inbound.Body | upcase | strip}}"
              ],
              "type": "matches_any_of",
              "value": "OUI,O,YES,Y,OK,1"
            }
          ]
        },
        {
          "next": "http_log_refus",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "NON refus√©",
              "arguments": [
                "{{widgets.msg_welcome_registration.inbound.Body | upcase | strip}}"
              ],
              "type": "matches_any_of",
              "value": "NON,N,NO,0"
            }
          ]
        },
        {
          "next": "http_handle_stop",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "STOP pendant inscription",
              "arguments": [
                "{{widgets.msg_welcome_registration.inbound.Body | upcase | strip}}"
              ],
              "type": "matches_any_of",
              "value": "STOP,ARRET,UNSUBSCRIBE"
            }
          ]
        },
        {
          "next": "handle_invalid_optin",
          "event": "noMatch"
        }
      ],
      "properties": {
        "input": "{{widgets.msg_welcome_registration.inbound.Body | upcase | strip}}",
        "offset": {
          "x": -600,
          "y": 2550
        }
      }
    },
    {
      "name": "handle_invalid_optin",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "msg_retry_optin",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Premi√®re tentative",
              "arguments": [
                "{{flow.variables.retry_count}}"
              ],
              "type": "less_than",
              "value": "1"
            }
          ]
        },
        {
          "next": "http_log_abandon",
          "event": "noMatch"
        }
      ],
      "properties": {
        "input": "{{flow.variables.retry_count}}",
        "offset": {
          "x": -1000,
          "y": 2550
        }
      }
    },
    {
      "name": "msg_retry_optin",
      "type": "send-and-wait-for-reply",
      "transitions": [
        {
          "next": "increment_retry_optin",
          "event": "incomingMessage"
        },
        {
          "next": "handle_timeout",
          "event": "timeout"
        },
        {
          "next": "handle_delivery_failure",
          "event": "deliveryFailure"
        }
      ],
      "properties": {
        "offset": {
          "x": -1000,
          "y": 2800
        },
        "from": "{{flow.channel.address}}",
        "body": "ü§î Je n'ai pas bien compris ta r√©ponse.\n\nPour t'inscrire √† SOLIBRA BABIFOOT CITY 2025 :\n‚úÖ Tu as 18 ans ou plus\n‚úÖ Tu acceptes nos messages\n\nüëâ Tape OUI pour confirmer\nüëâ Tape NON pour refuser\nüëâ Tape STOP pour annuler",
        "timeout": "1800"
      }
    },
    {
      "name": "increment_retry_optin",
      "type": "set-variables",
      "transitions": [
        {
          "next": "validate_optin_response",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "type": "number",
            "value": "{{flow.variables.retry_count | plus: 1}}",
            "key": "retry_count"
          }
        ],
        "offset": {
          "x": -1000,
          "y": 3050
        }
      }
    },
    {
      "name": "http_log_optin",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "reset_retry_for_name",
          "event": "success"
        },
        {
          "next": "reset_retry_for_name",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -600,
          "y": 2850
        },
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\n  \"phone\": \"{{flow.variables.phone_number}}\",\n  \"status\": \"OPTIN\",\n  \"timestamp\": \"{{now | date: '%Y-%m-%d %H:%M:%S'}}\"\n}",
        "url": "https://app-can-solibra.ywcdigital.com/api/can/optin",
        "timeout": 10000
      }
    },
    {
      "name": "reset_retry_for_name",
      "type": "set-variables",
      "transitions": [
        {
          "next": "msg_ask_name",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "type": "number",
            "value": "0",
            "key": "retry_count"
          }
        ],
        "offset": {
          "x": -600,
          "y": 3100
        }
      }
    },
    {
      "name": "msg_ask_name",
      "type": "send-and-wait-for-reply",
      "transitions": [
        {
          "next": "validate_name_input",
          "event": "incomingMessage"
        },
        {
          "next": "handle_timeout",
          "event": "timeout"
        },
        {
          "next": "handle_delivery_failure",
          "event": "deliveryFailure"
        }
      ],
      "properties": {
        "offset": {
          "x": -600,
          "y": 3350
        },
        "from": "{{flow.channel.address}}",
        "body": "Parfait ! ‚úÖ\n\nBienvenue dans la famille Solibra !\n\nüìù Quel est ton nom ou pseudo ?\n\n(Minimum 2 lettres)",
        "timeout": "3600"
      }
    },
    {
      "name": "validate_name_input",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "http_handle_stop",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "STOP pendant nom",
              "arguments": [
                "{{widgets.msg_ask_name.inbound.Body | upcase | strip}}"
              ],
              "type": "matches_any_of",
              "value": "STOP,ARRET,UNSUBSCRIBE"
            }
          ]
        },
        {
          "next": "set_user_name",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Nom valide (>= 2 caract√®res)",
              "arguments": [
                "{{widgets.msg_ask_name.inbound.Body | size}}"
              ],
              "type": "greater_than_or_equal_to",
              "value": "2"
            }
          ]
        },
        {
          "next": "handle_invalid_name",
          "event": "noMatch"
        }
      ],
      "properties": {
        "input": "{{widgets.msg_ask_name.inbound.Body}}",
        "offset": {
          "x": -600,
          "y": 3650
        }
      }
    },
    {
      "name": "handle_invalid_name",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "msg_retry_name",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Premi√®re tentative nom",
              "arguments": [
                "{{flow.variables.retry_count}}"
              ],
              "type": "less_than",
              "value": "1"
            }
          ]
        },
        {
          "next": "http_log_abandon",
          "event": "noMatch"
        }
      ],
      "properties": {
        "input": "{{flow.variables.retry_count}}",
        "offset": {
          "x": -1000,
          "y": 3650
        }
      }
    },
    {
      "name": "msg_retry_name",
      "type": "send-and-wait-for-reply",
      "transitions": [
        {
          "next": "increment_retry_name",
          "event": "incomingMessage"
        },
        {
          "next": "handle_timeout",
          "event": "timeout"
        },
        {
          "next": "handle_delivery_failure",
          "event": "deliveryFailure"
        }
      ],
      "properties": {
        "offset": {
          "x": -1000,
          "y": 3900
        },
        "from": "{{flow.channel.address}}",
        "body": "‚ùå Nom trop court !\n\nüìù Donne-moi ton pr√©nom ou pseudo (minimum 2 lettres).\n\nExemple : Jean, Marie, Champion, etc.\n\nüëâ Tape STOP pour annuler",
        "timeout": "1800"
      }
    },
    {
      "name": "increment_retry_name",
      "type": "set-variables",
      "transitions": [
        {
          "next": "validate_name_input",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "type": "number",
            "value": "{{flow.variables.retry_count | plus: 1}}",
            "key": "retry_count"
          }
        ],
        "offset": {
          "x": -1000,
          "y": 4150
        }
      }
    },
    {
      "name": "set_user_name",
      "type": "set-variables",
      "transitions": [
        {
          "next": "http_complete_registration",
          "event": "next"
        }
      ],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "{{widgets.msg_ask_name.inbound.Body | capitalize}}",
            "key": "user_name"
          }
        ],
        "offset": {
          "x": -600,
          "y": 3950
        }
      }
    },
    {
      "name": "http_complete_registration",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "msg_registration_success",
          "event": "success"
        },
        {
          "next": "handle_api_error",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -600,
          "y": 4200
        },
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\n  \"phone\": \"{{flow.variables.phone_number}}\",\n  \"name\": \"{{flow.variables.user_name}}\",\n  \"source_type\": \"{{flow.variables.source_type}}\",\n  \"source_detail\": \"{{flow.variables.source_detail}}\",\n  \"status\": \"INSCRIT\",\n  \"timestamp\": \"{{now | date: '%Y-%m-%d %H:%M:%S'}}\"\n}",
        "url": "https://app-can-solibra.ywcdigital.com/api/can/inscription",
        "timeout": 10000
      }
    },
    {
      "name": "msg_registration_success",
      "type": "send-message",
      "transitions": [
        {
          "next": "show_main_menu",
          "event": "sent"
        },
        {
          "next": "end_success",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -600,
          "y": 4450
        },
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "‚úÖ C'est bon {{flow.variables.user_name}} !\n\nTu fais partie de la TEAM SOLIBRA BABIFOOT CITY 2025 ‚öΩ\n\nüéÅ A gagner :\n‚Üí Casier de Bock ou World Cola\n‚Üí Bons d'achats\n‚Üí Maillots & accessoires\n\nPr√©pare-toi √† jouer et √† gagner !\n\n#BabiFootCity"
      }
    },
    {
      "name": "route_registered_user",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "show_main_menu",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Commande MENU",
              "arguments": [
                "{{flow.variables.clean_message}}"
              ],
              "type": "matches_any_of",
              "value": "MENU,AIDE,HELP,INFO"
            }
          ]
        },
        {
          "next": "subflow_matchs",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Voir matchs",
              "arguments": [
                "{{flow.variables.clean_message}}"
              ],
              "type": "matches_any_of",
              "value": "MATCHS,MATCH,1"
            }
          ]
        },
        {
          "next": "subflow_pronostic",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Faire pronostic",
              "arguments": [
                "{{flow.variables.clean_message}}"
              ],
              "type": "matches_any_of",
              "value": "PRONOSTIC,PRONO,2"
            }
          ]
        },
        {
          "next": "subflow_mes_pronos",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Mes pronostics",
              "arguments": [
                "{{flow.variables.clean_message}}"
              ],
              "type": "matches_any_of",
              "value": "MESPRONOS,MESPRONOSTICS,MESPRONO,3"
            }
          ]
        },
        {
          "next": "subflow_classement",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Classement",
              "arguments": [
                "{{flow.variables.clean_message}}"
              ],
              "type": "matches_any_of",
              "value": "CLASSEMENT,RANKING,LEADERBOARD,4"
            }
          ]
        },
        {
          "next": "subflow_quiz",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Quiz marques",
              "arguments": [
                "{{flow.variables.clean_message}}"
              ],
              "type": "matches_any_of",
              "value": "QUIZ,5,SOLIBRAVILLAGECAN"
            }
          ]
        },
        {
          "next": "msg_welcome_back",
          "event": "noMatch"
        }
      ],
      "properties": {
        "input": "{{flow.variables.clean_message}}",
        "offset": {
          "x": 800,
          "y": 1400
        }
      }
    },
    {
      "name": "msg_welcome_back",
      "type": "send-message",
      "transitions": [
        {
          "next": "show_main_menu",
          "event": "sent"
        },
        {
          "next": "end_already_registered",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 1300,
          "y": 1400
        },
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "üëã Salut {{widgets.http_check_user_status.parsed.name}} !\n\nContent de te revoir ! üéâ\n\nTu es d√©j√† inscrit(e) √† BABIFOOT CITY by Solibra 2025 ‚öΩ\n\n#BabiFootCity"
      }
    },
    {
      "name": "show_main_menu",
      "type": "send-and-wait-for-reply",
      "transitions": [
        {
          "next": "process_menu_choice",
          "event": "incomingMessage"
        },
        {
          "next": "end_success",
          "event": "timeout"
        },
        {
          "next": "handle_delivery_failure",
          "event": "deliveryFailure"
        }
      ],
      "properties": {
        "offset": {
          "x": 800,
          "y": 1700
        },
        "from": "{{flow.channel.address}}",
        "body": "üéØ MENU PRINCIPAL\n\nQue veux-tu faire ?\n\n1Ô∏è‚É£ MATCHS - Voir les matchs √† venir\n2Ô∏è‚É£ PRONOSTIC - Faire un pronostic\n3Ô∏è‚É£ MES PRONOS - Voir mes pronostics\n4Ô∏è‚É£ CLASSEMENT - Voir le classement\n5Ô∏è‚É£ QUIZ - Quiz sur les marques\n\nüëâ Tape le num√©ro ou le mot-cl√©\nüìµ Tape STOP pour te d√©sinscrire",
        "timeout": "3600"
      }
    },
    {
      "name": "process_menu_choice",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "http_handle_stop",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "STOP depuis menu",
              "arguments": [
                "{{widgets.show_main_menu.inbound.Body | upcase | strip}}"
              ],
              "type": "matches_any_of",
              "value": "STOP,ARRET,UNSUBSCRIBE"
            }
          ]
        },
        {
          "next": "subflow_matchs",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Choix 1 - Matchs",
              "arguments": [
                "{{widgets.show_main_menu.inbound.Body | upcase | strip}}"
              ],
              "type": "matches_any_of",
              "value": "1,MATCHS,MATCH"
            }
          ]
        },
        {
          "next": "subflow_pronostic",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Choix 2 - Pronostic",
              "arguments": [
                "{{widgets.show_main_menu.inbound.Body | upcase | strip}}"
              ],
              "type": "matches_any_of",
              "value": "2,PRONOSTIC,PRONO"
            }
          ]
        },
        {
          "next": "subflow_mes_pronos",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Choix 3 - Mes pronos",
              "arguments": [
                "{{widgets.show_main_menu.inbound.Body | upcase | strip}}"
              ],
              "type": "matches_any_of",
              "value": "3,MESPRONOS,MESPRONO,MESPRONOSTICS"
            }
          ]
        },
        {
          "next": "subflow_classement",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Choix 4 - Classement",
              "arguments": [
                "{{widgets.show_main_menu.inbound.Body | upcase | strip}}"
              ],
              "type": "matches_any_of",
              "value": "4,CLASSEMENT,RANKING,LEADERBOARD"
            }
          ]
        },
        {
          "next": "subflow_quiz",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "Choix 5 - Quiz",
              "arguments": [
                "{{widgets.show_main_menu.inbound.Body | upcase | strip}}"
              ],
              "type": "matches_any_of",
              "value": "5,QUIZ"
            }
          ]
        },
        {
          "next": "handle_invalid_menu_choice",
          "event": "noMatch"
        }
      ],
      "properties": {
        "input": "{{widgets.show_main_menu.inbound.Body | upcase | strip}}",
        "offset": {
          "x": 800,
          "y": 2000
        }
      }
    },
    {
      "name": "handle_invalid_menu_choice",
      "type": "send-message",
      "transitions": [
        {
          "next": "show_main_menu",
          "event": "sent"
        },
        {
          "next": "end_error",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 1300,
          "y": 2000
        },
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "‚ùå Choix invalide !\n\nMerci de choisir un num√©ro entre 1 et 5, ou d'utiliser les mots-cl√©s :\n\n‚Ä¢ MATCHS ou 1\n‚Ä¢ PRONOSTIC ou 2\n‚Ä¢ MES PRONOS ou 3\n‚Ä¢ CLASSEMENT ou 4\n‚Ä¢ QUIZ ou 5\n\nTape MENU pour revoir les options."
      }
    },
    {
      "name": "handle_reactivation",
      "type": "send-and-wait-for-reply",
      "transitions": [
        {
          "next": "validate_reactivation",
          "event": "incomingMessage"
        },
        {
          "next": "handle_timeout",
          "event": "timeout"
        },
        {
          "next": "handle_delivery_failure",
          "event": "deliveryFailure"
        }
      ],
      "properties": {
        "offset": {
          "x": 400,
          "y": 1400
        },
        "from": "{{flow.channel.address}}",
        "body": "üëã Salut {{widgets.http_check_user_status.parsed.name}} !\n\nTu t'√©tais d√©sinscrit(e) de SOLIBRA BABIFOOT CITY.\n\nüéÅ Tu veux te r√©inscrire pour participer aux jeux et gagner des cadeaux ?\n\n‚ö†Ô∏è Confirme :\n‚úÖ 18 ans ou plus\n‚úÖ Tu acceptes nos messages\n\nüëâ Tape OUI pour revenir\nüëâ Tape NON pour rester d√©sinscrit(e)",
        "timeout": "3600"
      }
    },
    {
      "name": "validate_reactivation",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "http_reactivate_user",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "OUI r√©activation",
              "arguments": [
                "{{widgets.handle_reactivation.inbound.Body | upcase | strip}}"
              ],
              "type": "matches_any_of",
              "value": "OUI,O,YES,Y,OK,1"
            }
          ]
        },
        {
          "next": "msg_stay_unsubscribed",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "NON ou STOP",
              "arguments": [
                "{{widgets.handle_reactivation.inbound.Body | upcase | strip}}"
              ],
              "type": "matches_any_of",
              "value": "NON,N,NO,0,STOP,ARRET"
            }
          ]
        },
        {
          "next": "msg_invalid_reactivation",
          "event": "noMatch"
        }
      ],
      "properties": {
        "input": "{{widgets.handle_reactivation.inbound.Body | upcase | strip}}",
        "offset": {
          "x": 400,
          "y": 1700
        }
      }
    },
    {
      "name": "msg_invalid_reactivation",
      "type": "send-message",
      "transitions": [
        {
          "next": "handle_reactivation",
          "event": "sent"
        },
        {
          "next": "end_error",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 0,
          "y": 1700
        },
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "ü§î Je n'ai pas compris.\n\nPour te r√©inscrire :\nüëâ Tape OUI\n\nPour rester d√©sinscrit(e) :\nüëâ Tape NON"
      }
    },
    {
      "name": "http_reactivate_user",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "msg_reactivation_success",
          "event": "success"
        },
        {
          "next": "handle_api_error",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 400,
          "y": 2000
        },
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\n  \"phone\": \"{{flow.variables.phone_number}}\",\n  \"status\": \"REACTIVATED\",\n  \"timestamp\": \"{{now | date: '%Y-%m-%d %H:%M:%S'}}\"\n}",
        "url": "https://app-can-solibra.ywcdigital.com/api/can/reactivate",
        "timeout": 10000
      }
    },
    {
      "name": "msg_reactivation_success",
      "type": "send-message",
      "transitions": [
        {
          "next": "show_main_menu",
          "event": "sent"
        },
        {
          "next": "end_reactivated",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 400,
          "y": 2250
        },
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "üéâ Content de te revoir {{widgets.http_check_user_status.parsed.name}} !\n\nTu es de retour dans la FAMILLE SOLIBRA BABIFOOT CITY 2025 ! ‚öΩ\n\nüîú Tu peux maintenant :\n‚Üí Faire des pronostics\n‚Üí Participer aux quiz\n‚Üí Gagner des cadeaux\n\nPr√©pare-toi ! üèÜ\n\n#BabiFootCity"
      }
    },
    {
      "name": "msg_stay_unsubscribed",
      "type": "send-message",
      "transitions": [
        {
          "next": "end_stop",
          "event": "sent"
        },
        {
          "next": "end_stop",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 700,
          "y": 1700
        },
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "OK, pas de souci ! üëã\n\nTu restes d√©sinscrit(e).\n\nSi tu changes d'avis, envoie-nous OUI.\n\nA bient√¥t ! ‚öΩ"
      }
    },
    {
      "name": "http_handle_stop",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "msg_stop_confirmation",
          "event": "success"
        },
        {
          "next": "msg_stop_confirmation",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 400,
          "y": 600
        },
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\n  \"phone\": \"{{flow.variables.phone_number}}\",\n  \"status\": \"STOP\",\n  \"timestamp\": \"{{now | date: '%Y-%m-%d %H:%M:%S'}}\"\n}",
        "url": "https://app-can-solibra.ywcdigital.com/api/can/stop",
        "timeout": 10000
      }
    },
    {
      "name": "msg_stop_confirmation",
      "type": "send-message",
      "transitions": [
        {
          "next": "end_stop",
          "event": "sent"
        },
        {
          "next": "end_stop",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 400,
          "y": 850
        },
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "‚úÖ C'est not√©.\n\nTu es d√©sinscrit(e) et ne recevras plus de messages de SOLIBRA BABIFOOT CITY.\n\nPour te r√©inscrire plus tard, envoie-nous OUI.\n\nA bient√¥t ! ‚öΩ"
      }
    },
    {
      "name": "http_log_refus",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "msg_refus",
          "event": "success"
        },
        {
          "next": "msg_refus",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -200,
          "y": 2850
        },
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\n  \"phone\": \"{{flow.variables.phone_number}}\",\n  \"status\": \"REFUS\",\n  \"timestamp\": \"{{now | date: '%Y-%m-%d %H:%M:%S'}}\"\n}",
        "url": "https://app-can-solibra.ywcdigital.com/api/can/refus",
        "timeout": 10000
      }
    },
    {
      "name": "msg_refus",
      "type": "send-message",
      "transitions": [
        {
          "next": "end_refus",
          "event": "sent"
        },
        {
          "next": "end_refus",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -200,
          "y": 3100
        },
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "Pas de probl√®me ! üëã\n\nSi tu changes d'avis, envoie-nous OUI pour t'inscrire.\n\nAllez les L√©opards ! ü¶Å\n\n#BabiFootCity"
      }
    },
    {
      "name": "http_log_abandon",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "msg_abandon",
          "event": "success"
        },
        {
          "next": "msg_abandon",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -1400,
          "y": 2850
        },
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\n  \"phone\": \"{{flow.variables.phone_number}}\",\n  \"status\": \"ABANDON\",\n  \"timestamp\": \"{{now | date: '%Y-%m-%d %H:%M:%S'}}\"\n}",
        "url": "https://app-can-solibra.ywcdigital.com/api/can/abandon",
        "timeout": 10000
      }
    },
    {
      "name": "msg_abandon",
      "type": "send-message",
      "transitions": [
        {
          "next": "end_abandon",
          "event": "sent"
        },
        {
          "next": "end_abandon",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -1400,
          "y": 3100
        },
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "‚è±Ô∏è Trop de tentatives non valides.\n\nPas de probl√®me ! üëã\n\nSi tu veux t'inscrire, envoie-nous OUI.\n\nA bient√¥t ! ‚öΩ"
      }
    },
    {
      "name": "handle_timeout",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "msg_timeout",
          "event": "success"
        },
        {
          "next": "msg_timeout",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -1800,
          "y": 1400
        },
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\n  \"phone\": \"{{flow.variables.phone_number}}\",\n  \"status\": \"TIMEOUT\",\n  \"timestamp\": \"{{now | date: '%Y-%m-%d %H:%M:%S'}}\"\n}",
        "url": "https://app-can-solibra.ywcdigital.com/api/can/timeout",
        "timeout": 10000
      }
    },
    {
      "name": "msg_timeout",
      "type": "send-message",
      "transitions": [
        {
          "next": "end_timeout",
          "event": "sent"
        },
        {
          "next": "end_timeout",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -1800,
          "y": 1650
        },
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "‚è±Ô∏è Temps √©coul√© !\n\nPas de r√©ponse re√ßue.\n\nPour recommencer, envoie-nous un message.\n\nA bient√¥t ! ‚öΩ"
      }
    },
    {
      "name": "handle_delivery_failure",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "end_error",
          "event": "success"
        },
        {
          "next": "end_error",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -1800,
          "y": 1900
        },
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\n  \"phone\": \"{{flow.variables.phone_number}}\",\n  \"status\": \"DELIVERY_FAILURE\",\n  \"error\": \"Message delivery failed\",\n  \"timestamp\": \"{{now | date: '%Y-%m-%d %H:%M:%S'}}\"\n}",
        "url": "https://app-can-solibra.ywcdigital.com/api/can/error",
        "timeout": 10000
      }
    },
    {
      "name": "handle_api_error",
      "type": "send-message",
      "transitions": [
        {
          "next": "log_api_error",
          "event": "sent"
        },
        {
          "next": "log_api_error",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -1800,
          "y": 2400
        },
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "‚ö†Ô∏è Une erreur technique est survenue.\n\nMerci de r√©essayer dans quelques instants.\n\nSi le probl√®me persiste, contacte notre support.\n\nD√©sol√© pour la g√™ne ! üôè"
      }
    },
    {
      "name": "log_api_error",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "end_error",
          "event": "success"
        },
        {
          "next": "end_error",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -1800,
          "y": 2650
        },
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\n  \"phone\": \"{{flow.variables.phone_number}}\",\n  \"status\": \"API_ERROR\",\n  \"error\": \"API request failed or timed out\",\n  \"timestamp\": \"{{now | date: '%Y-%m-%d %H:%M:%S'}}\"\n}",
        "url": "https://app-can-solibra.ywcdigital.com/api/can/error",
        "timeout": 5000
      }
    },
    {
      "name": "subflow_matchs",
      "type": "run-subflow",
      "transitions": [
        {
          "next": "end_success",
          "event": "completed"
        },
        {
          "next": "handle_subflow_error",
          "event": "failed"
        }
      ],
      "properties": {
        "flow_sid": "FWf255f47348477f7b361f4b7df59d5fd5",
        "flow_revision": "LatestPublished",
        "offset": {
          "x": 1600,
          "y": 1700
        },
        "parameters": [
          {
            "key": "phone_number",
            "value": "{{flow.variables.phone_number}}"
          },
          {
            "key": "user_name",
            "value": "{{widgets.http_check_user_status.parsed.name}}"
          }
        ]
      }
    },
    {
      "name": "subflow_pronostic",
      "type": "run-subflow",
      "transitions": [
        {
          "next": "end_success",
          "event": "completed"
        },
        {
          "next": "handle_subflow_error",
          "event": "failed"
        }
      ],
      "properties": {
        "flow_sid": "FW26cc752ab63630c73404fab72632f65c",
        "flow_revision": "LatestPublished",
        "offset": {
          "x": 1600,
          "y": 2000
        },
        "parameters": [
          {
            "key": "phone_number",
            "value": "{{flow.variables.phone_number}}"
          },
          {
            "key": "user_name",
            "value": "{{widgets.http_check_user_status.parsed.name}}"
          }
        ]
      }
    },
    {
      "name": "subflow_mes_pronos",
      "type": "run-subflow",
      "transitions": [
        {
          "next": "end_success",
          "event": "completed"
        },
        {
          "next": "handle_subflow_error",
          "event": "failed"
        }
      ],
      "properties": {
        "flow_sid": "FW_MES_PRONOS_SID_HERE",
        "flow_revision": "LatestPublished",
        "offset": {
          "x": 1600,
          "y": 2300
        },
        "parameters": [
          {
            "key": "phone_number",
            "value": "{{flow.variables.phone_number}}"
          }
        ]
      }
    },
    {
      "name": "subflow_classement",
      "type": "run-subflow",
      "transitions": [
        {
          "next": "end_success",
          "event": "completed"
        },
        {
          "next": "handle_subflow_error",
          "event": "failed"
        }
      ],
      "properties": {
        "flow_sid": "FW_CLASSEMENT_SID_HERE",
        "flow_revision": "LatestPublished",
        "offset": {
          "x": 1600,
          "y": 2600
        },
        "parameters": [
          {
            "key": "phone_number",
            "value": "{{flow.variables.phone_number}}"
          }
        ]
      }
    },
    {
      "name": "subflow_quiz",
      "type": "run-subflow",
      "transitions": [
        {
          "next": "end_success",
          "event": "completed"
        },
        {
          "next": "handle_subflow_error",
          "event": "failed"
        }
      ],
      "properties": {
        "flow_sid": "FW6643799ed631c2c6a966923e94e11cce",
        "flow_revision": "LatestPublished",
        "offset": {
          "x": 1600,
          "y": 2900
        },
        "parameters": [
          {
            "key": "phone_number",
            "value": "{{flow.variables.phone_number}}"
          },
          {
            "key": "user_name",
            "value": "{{widgets.http_check_user_status.parsed.name}}"
          }
        ]
      }
    },
    {
      "name": "handle_subflow_error",
      "type": "send-message",
      "transitions": [
        {
          "next": "show_main_menu",
          "event": "sent"
        },
        {
          "next": "end_error",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 2000,
          "y": 2300
        },
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "‚ö†Ô∏è Une erreur est survenue lors du traitement de ta demande.\n\nMerci de r√©essayer.\n\nTape MENU pour voir les options disponibles."
      }
    },
    {
      "name": "end_success",
      "type": "set-variables",
      "transitions": [],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "SUCCESS",
            "key": "flow_status"
          }
        ],
        "offset": {
          "x": 800,
          "y": 4700
        }
      }
    },
    {
      "name": "end_already_registered",
      "type": "set-variables",
      "transitions": [],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "ALREADY_REGISTERED",
            "key": "flow_status"
          }
        ],
        "offset": {
          "x": 1300,
          "y": 1900
        }
      }
    },
    {
      "name": "end_reactivated",
      "type": "set-variables",
      "transitions": [],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "REACTIVATED",
            "key": "flow_status"
          }
        ],
        "offset": {
          "x": 400,
          "y": 2500
        }
      }
    },
    {
      "name": "end_stop",
      "type": "set-variables",
      "transitions": [],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "STOP",
            "key": "flow_status"
          }
        ],
        "offset": {
          "x": 700,
          "y": 1100
        }
      }
    },
    {
      "name": "end_refus",
      "type": "set-variables",
      "transitions": [],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "REFUS",
            "key": "flow_status"
          }
        ],
        "offset": {
          "x": -200,
          "y": 3350
        }
      }
    },
    {
      "name": "end_abandon",
      "type": "set-variables",
      "transitions": [],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "ABANDON",
            "key": "flow_status"
          }
        ],
        "offset": {
          "x": -1400,
          "y": 3350
        }
      }
    },
    {
      "name": "end_timeout",
      "type": "set-variables",
      "transitions": [],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "TIMEOUT",
            "key": "flow_status"
          }
        ],
        "offset": {
          "x": -1800,
          "y": 1900
        }
      }
    },
    {
      "name": "end_error",
      "type": "set-variables",
      "transitions": [],
      "properties": {
        "variables": [
          {
            "type": "string",
            "value": "ERROR",
            "key": "flow_status"
          }
        ],
        "offset": {
          "x": -1800,
          "y": 2900
        }
      }
    }
  ],
  "initial_state": "Trigger",
  "flags": {
    "allow_concurrent_calls": true
  }
}
