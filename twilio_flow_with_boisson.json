{
  "description": "CAN 2025 - Flow avec Boisson Pr√©f√©r√©e int√©gr√©e",
  "states": [
    {
      "name": "Trigger",
      "type": "trigger",
      "transitions": [
        {
          "event": "incomingMessage"
        },
        {
          "event": "incomingCall"
        },
        {
          "event": "incomingConversationMessage"
        },
        {
          "event": "incomingRequest"
        },
        {
          "next": "set_phone",
          "event": "incomingParent"
        }
      ],
      "properties": {
        "offset": {"x": -170, "y": -720}
      }
    },
    {
      "name": "set_phone",
      "type": "set-variables",
      "transitions": [{"next": "check_stop_keyword", "event": "next"}],
      "properties": {
        "variables": [
          {"value": "{{trigger.message.From}}", "key": "phone_number"},
          {"value": "{{trigger.message.Body}}", "key": "user_message"},
          {"value": "{{now | date: '%Y-%m-%d %H:%M:%S'}}", "key": "timestamp"}
        ],
        "offset": {"x": 0, "y": -360}
      }
    },
    {
      "name": "check_stop_keyword",
      "type": "split-based-on",
      "transitions": [
        {"next": "check_source", "event": "noMatch"},
        {"next": "http_log_stop", "event": "match", "conditions": [
          {"friendly_name": "STOP demand√©", "arguments": ["{{trigger.message.Body}}"], "type": "matches_any_of", "value": "STOP,stop,Stop,ARRET,arret,Arret"}
        ]}
      ],
      "properties": {
        "input": "{{trigger.message.Body}}",
        "offset": {"x": -60, "y": -130}
      }
    },
    {
      "name": "check_source",
      "type": "split-based-on",
      "transitions": [
        {"next": "set_source_direct", "event": "noMatch"},
        {"next": "set_source_affiche", "event": "match", "conditions": [
          {"friendly_name": "Source Affiche", "arguments": ["{{trigger.message.Body}}"], "type": "matches_any_of", "value": "START_AFF_GOMBE,START_AFF_MASINA,START_AFF_LEMBA,START_AFF_BANDAL,START_AFF_NGALI,START_AFF_MATETE,START_AFF_KINTAMBO,START_AFF_NDJILI,START_AFF_LIMETE"}
        ]},
        {"next": "set_source_pdv", "event": "match", "conditions": [
          {"friendly_name": "Source PDV", "arguments": ["{{trigger.message.Body}}"], "type": "matches_any_of", "value": "START_PDV_BRACONGO,START_PDV_BAR1,START_PDV_BAR2,START_PDV_DEPOT1,START_PDV_DEPOT2"}
        ]},
        {"next": "set_source_digital", "event": "match", "conditions": [
          {"friendly_name": "Source Digital", "arguments": ["{{trigger.message.Body}}"], "type": "matches_any_of", "value": "START_FB,START_IG,START_TIKTOK,START_WA_STATUS,START_WEB"}
        ]}
      ],
      "properties": {
        "input": "{{trigger.message.Body}}",
        "offset": {"x": -30, "y": 190}
      }
    },
    {
      "name": "set_source_affiche",
      "type": "set-variables",
      "transitions": [{"next": "http_check_user", "event": "next"}],
      "properties": {
        "variables": [
          {"value": "AFFICHE", "key": "source_type"},
          {"value": "{{trigger.message.Body | replace: 'START_AFF_', ''}}", "key": "source_detail"}
        ],
        "offset": {"x": -1230, "y": 480}
      }
    },
    {
      "name": "set_source_pdv",
      "type": "set-variables",
      "transitions": [{"next": "http_check_user", "event": "next"}],
      "properties": {
        "variables": [
          {"value": "PDV_BRACONGO", "key": "source_type"},
          {"value": "{{trigger.message.Body | replace: 'START_PDV_', ''}}", "key": "source_detail"}
        ],
        "offset": {"x": -860, "y": 470}
      }
    },
    {
      "name": "set_source_digital",
      "type": "set-variables",
      "transitions": [{"next": "http_check_user", "event": "next"}],
      "properties": {
        "variables": [
          {"value": "DIGITAL", "key": "source_type"},
          {"value": "{{trigger.message.Body | replace: 'START_', ''}}", "key": "source_detail"}
        ],
        "offset": {"x": -420, "y": 480}
      }
    },
    {
      "name": "set_source_direct",
      "type": "set-variables",
      "transitions": [{"next": "http_check_user", "event": "next"}],
      "properties": {
        "variables": [
          {"value": "DIRECT", "key": "source_type"},
          {"value": "SANS_QR", "key": "source_detail"}
        ],
        "offset": {"x": 1050, "y": 460}
      }
    },
    {
      "name": "http_check_user",
      "type": "make-http-request",
      "transitions": [
        {"next": "check_user_status", "event": "success"},
        {"next": "http_log_scan", "event": "failed"}
      ],
      "properties": {
        "offset": {"x": 0, "y": 700},
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\"phone\": \"{{flow.variables.phone_number}}\"}",
        "url": "https://can-wabracongo.ywcdigital.com/api/can/check-user"
      }
    },
    {
      "name": "check_user_status",
      "type": "split-based-on",
      "transitions": [
        {"next": "http_log_scan", "event": "noMatch"},
        {"next": "http_log_scan", "event": "match", "conditions": [
          {"friendly_name": "Nouvel utilisateur", "arguments": ["{{widgets.http_check_user.parsed.status}}"], "type": "equal_to", "value": "NOT_FOUND"}
        ]},
        {"next": "check_has_boisson", "event": "match", "conditions": [
          {"friendly_name": "D√©j√† inscrit", "arguments": ["{{widgets.http_check_user.parsed.status}}"], "type": "equal_to", "value": "INSCRIT"}
        ]},
        {"next": "msg_reactivation", "event": "match", "conditions": [
          {"friendly_name": "Ancien STOP", "arguments": ["{{widgets.http_check_user.parsed.status}}"], "type": "equal_to", "value": "STOP"}
        ]}
      ],
      "properties": {
        "input": "{{widgets.http_check_user.parsed.status}}",
        "offset": {"x": 0, "y": 920}
      }
    },
    {
      "name": "check_has_boisson",
      "type": "split-based-on",
      "transitions": [
        {"next": "msg_demande_boisson_manquante", "event": "match", "conditions": [
          {"friendly_name": "Pas de boisson", "arguments": ["{{widgets.http_check_user.parsed.has_boisson_preferee}}"], "type": "equal_to", "value": "false"}
        ]},
        {"next": "http_check_pronostics", "event": "noMatch"}
      ],
      "properties": {
        "input": "{{widgets.http_check_user.parsed.has_boisson_preferee}}",
        "offset": {"x": 300, "y": 920}
      }
    },
    {
      "name": "msg_demande_boisson_manquante",
      "type": "send-and-wait-for-reply",
      "transitions": [
        {"next": "validate_boisson_existant", "event": "incomingMessage"},
        {"next": "http_check_pronostics", "event": "timeout"},
        {"next": "http_check_pronostics", "event": "deliveryFailure"}
      ],
      "properties": {
        "offset": {"x": 300, "y": 1150},
        "from": "{{flow.channel.address}}",
        "body": "üëã Salut {{widgets.http_check_user.parsed.name}} !\n\nAvant de continuer, j'ai besoin d'une info :\n\nüçπ Quelle est ta boisson pr√©f√©r√©e ?\n\n1. Bock\n2. 33 Export\n3. World Cola\n4. Coca Cola\n5. Fanta Orange\n6. Sprite\n7. Eau min√©rale\n8. Autre\n\nüëâ Tape le num√©ro (1-8)",
        "timeout": "1800"
      }
    },
    {
      "name": "validate_boisson_existant",
      "type": "split-based-on",
      "transitions": [
        {"next": "msg_retry_boisson_existant", "event": "noMatch"},
        {"next": "set_boisson_existant_bock", "event": "match", "conditions": [
          {"friendly_name": "Choix 1 - Bock", "arguments": ["{{widgets.msg_demande_boisson_manquante.inbound.Body}}"], "type": "matches_any_of", "value": "1,BOCK,Bock,bock"}
        ]},
        {"next": "set_boisson_existant_33export", "event": "match", "conditions": [
          {"friendly_name": "Choix 2 - 33 Export", "arguments": ["{{widgets.msg_demande_boisson_manquante.inbound.Body}}"], "type": "matches_any_of", "value": "2,33 EXPORT,33 Export,33export"}
        ]},
        {"next": "set_boisson_existant_worldcola", "event": "match", "conditions": [
          {"friendly_name": "Choix 3 - World Cola", "arguments": ["{{widgets.msg_demande_boisson_manquante.inbound.Body}}"], "type": "matches_any_of", "value": "3,WORLD COLA,World Cola,worldcola"}
        ]},
        {"next": "set_boisson_existant_coca", "event": "match", "conditions": [
          {"friendly_name": "Choix 4 - Coca Cola", "arguments": ["{{widgets.msg_demande_boisson_manquante.inbound.Body}}"], "type": "matches_any_of", "value": "4,COCA COLA,Coca Cola,coca"}
        ]},
        {"next": "set_boisson_existant_fanta", "event": "match", "conditions": [
          {"friendly_name": "Choix 5 - Fanta", "arguments": ["{{widgets.msg_demande_boisson_manquante.inbound.Body}}"], "type": "matches_any_of", "value": "5,FANTA,Fanta Orange,fanta"}
        ]},
        {"next": "set_boisson_existant_sprite", "event": "match", "conditions": [
          {"friendly_name": "Choix 6 - Sprite", "arguments": ["{{widgets.msg_demande_boisson_manquante.inbound.Body}}"], "type": "matches_any_of", "value": "6,SPRITE,Sprite,sprite"}
        ]},
        {"next": "set_boisson_existant_eau", "event": "match", "conditions": [
          {"friendly_name": "Choix 7 - Eau", "arguments": ["{{widgets.msg_demande_boisson_manquante.inbound.Body}}"], "type": "matches_any_of", "value": "7,EAU,Eau,eau,Eau min√©rale"}
        ]},
        {"next": "set_boisson_existant_autre", "event": "match", "conditions": [
          {"friendly_name": "Choix 8 - Autre", "arguments": ["{{widgets.msg_demande_boisson_manquante.inbound.Body}}"], "type": "matches_any_of", "value": "8,AUTRE,Autre,autre"}
        ]}
      ],
      "properties": {
        "input": "{{widgets.msg_demande_boisson_manquante.inbound.Body}}",
        "offset": {"x": 300, "y": 1400}
      }
    },
    {
      "name": "msg_retry_boisson_existant",
      "type": "send-and-wait-for-reply",
      "transitions": [
        {"next": "validate_boisson_existant", "event": "incomingMessage"},
        {"next": "http_check_pronostics", "event": "timeout"}
      ],
      "properties": {
        "offset": {"x": 0, "y": 1650},
        "from": "{{flow.channel.address}}",
        "body": "‚ùå Choix invalide !\n\nüçπ Quelle est ta boisson pr√©f√©r√©e ?\n\n1. Bock\n2. 33 Export\n3. World Cola\n4. Coca Cola\n5. Fanta Orange\n6. Sprite\n7. Eau min√©rale\n8. Autre\n\nüëâ Tape le num√©ro (1-8)",
        "timeout": "1800"
      }
    },
    {
      "name": "set_boisson_existant_bock",
      "type": "set-variables",
      "transitions": [{"next": "http_save_boisson_existant", "event": "next"}],
      "properties": {
        "variables": [{"value": "Bock", "key": "boisson_preferee"}],
        "offset": {"x": 600, "y": 1650}
      }
    },
    {
      "name": "set_boisson_existant_33export",
      "type": "set-variables",
      "transitions": [{"next": "http_save_boisson_existant", "event": "next"}],
      "properties": {
        "variables": [{"value": "33 Export", "key": "boisson_preferee"}],
        "offset": {"x": 700, "y": 1650}
      }
    },
    {
      "name": "set_boisson_existant_worldcola",
      "type": "set-variables",
      "transitions": [{"next": "http_save_boisson_existant", "event": "next"}],
      "properties": {
        "variables": [{"value": "World Cola", "key": "boisson_preferee"}],
        "offset": {"x": 800, "y": 1650}
      }
    },
    {
      "name": "set_boisson_existant_coca",
      "type": "set-variables",
      "transitions": [{"next": "http_save_boisson_existant", "event": "next"}],
      "properties": {
        "variables": [{"value": "Coca Cola", "key": "boisson_preferee"}],
        "offset": {"x": 900, "y": 1650}
      }
    },
    {
      "name": "set_boisson_existant_fanta",
      "type": "set-variables",
      "transitions": [{"next": "http_save_boisson_existant", "event": "next"}],
      "properties": {
        "variables": [{"value": "Fanta Orange", "key": "boisson_preferee"}],
        "offset": {"x": 1000, "y": 1650}
      }
    },
    {
      "name": "set_boisson_existant_sprite",
      "type": "set-variables",
      "transitions": [{"next": "http_save_boisson_existant", "event": "next"}],
      "properties": {
        "variables": [{"value": "Sprite", "key": "boisson_preferee"}],
        "offset": {"x": 1100, "y": 1650}
      }
    },
    {
      "name": "set_boisson_existant_eau",
      "type": "set-variables",
      "transitions": [{"next": "http_save_boisson_existant", "event": "next"}],
      "properties": {
        "variables": [{"value": "Eau min√©rale", "key": "boisson_preferee"}],
        "offset": {"x": 1200, "y": 1650}
      }
    },
    {
      "name": "set_boisson_existant_autre",
      "type": "set-variables",
      "transitions": [{"next": "http_save_boisson_existant", "event": "next"}],
      "properties": {
        "variables": [{"value": "Autre", "key": "boisson_preferee"}],
        "offset": {"x": 1300, "y": 1650}
      }
    },
    {
      "name": "http_save_boisson_existant",
      "type": "make-http-request",
      "transitions": [
        {"next": "msg_boisson_enregistree", "event": "success"},
        {"next": "http_check_pronostics", "event": "failed"}
      ],
      "properties": {
        "offset": {"x": 900, "y": 1900},
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\"phone\": \"{{flow.variables.phone_number}}\", \"boisson_preferee\": \"{{flow.variables.boisson_preferee}}\"}",
        "url": "https://can-wabracongo.ywcdigital.com/api/can/set-boisson"
      }
    },
    {
      "name": "msg_boisson_enregistree",
      "type": "send-message",
      "transitions": [
        {"next": "http_check_pronostics", "event": "sent"},
        {"next": "http_check_pronostics", "event": "failed"}
      ],
      "properties": {
        "offset": {"x": 900, "y": 2150},
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "‚úÖ Merci ! Ta pr√©f√©rence pour {{flow.variables.boisson_preferee}} a √©t√© enregistr√©e ! üçπ"
      }
    },
    {
      "name": "http_check_pronostics",
      "type": "make-http-request",
      "transitions": [
        {"next": "check_pronostics_status", "event": "success"},
        {"next": "msg_deja_inscrit_simple", "event": "failed"}
      ],
      "properties": {
        "offset": {"x": 540, "y": 920},
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\"phone\":\"{{flow.variables.phone_number}}\"}",
        "url": "https://can-wabracongo.ywcdigital.com/api/can/user-pronostics"
      }
    },
    {
      "name": "check_pronostics_status",
      "type": "split-based-on",
      "transitions": [
        {"next": "msg_remaining_matches", "event": "noMatch"},
        {"next": "msg_historique_complet", "event": "match", "conditions": [
          {"friendly_name": "Tous les pronostics faits", "arguments": ["{{widgets.http_check_pronostics.parsed.has_all_pronostics}}"], "type": "equal_to", "value": "true"}
        ]},
        {"next": "msg_remaining_matches", "event": "match", "conditions": [
          {"friendly_name": "Des matchs restants", "arguments": ["{{widgets.http_check_pronostics.parsed.has_all_pronostics}}"], "type": "greater_than", "value": "0"}
        ]}
      ],
      "properties": {
        "input": "{{widgets.http_check_pronostics.parsed.has_all_pronostics}}",
        "offset": {"x": 430, "y": 1160}
      }
    },
    {
      "name": "msg_historique_complet",
      "type": "send-message",
      "transitions": [
        {"next": "end_historique_complet", "event": "sent"},
        {"next": "end_historique_complet", "event": "failed"}
      ],
      "properties": {
        "offset": {"x": 700, "y": 1420},
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "üëã Salut {{widgets.http_check_user.parsed.name}} !\n\n‚úÖ Tu as d√©j√† fait tous tes pronostics disponibles !\n\n{{widgets.http_check_pronostics.parsed.historique_message}}\nüçÄ Bonne chance pour tes paris !\n\nüìµ Tape STOP pour te d√©sinscrire"
      }
    },
    {
      "name": "msg_remaining_matches",
      "type": "send-message",
      "transitions": [
        {"next": "end_deja_inscrit", "event": "sent"},
        {"next": "end_deja_inscrit", "event": "failed"}
      ],
      "properties": {
        "offset": {"x": 200, "y": 1420},
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "üëã Salut {{widgets.http_check_user.parsed.name}} !\n\n{{widgets.http_check_pronostics.parsed.historique_message}}{{widgets.http_check_pronostics.parsed.remaining_matches_message}}\n\n#BabiFootCity\n\nüìµ Tape STOP pour te d√©sinscrire"
      }
    },
    {
      "name": "msg_deja_inscrit_simple",
      "type": "send-message",
      "transitions": [
        {"next": "end_deja_inscrit", "event": "sent"},
        {"next": "end_deja_inscrit", "event": "failed"}
      ],
      "properties": {
        "offset": {"x": 540, "y": 1670},
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "üëã Salut {{widgets.http_check_user.parsed.name}} !\n\nTu es d√©j√† inscrit(e) √†  ‚öΩNDEMBO CITY by 33 Export 2025 \n\nüîîPr√©pare-toi √† jouer et √† gagner !\n\n#NdemboCity\n\nüìµ Tape STOP pour te d√©sinscrire"
      }
    },
    {
      "name": "end_historique_complet",
      "type": "set-variables",
      "transitions": [],
      "properties": {
        "variables": [{"value": "HISTORIQUE_COMPLET", "key": "flow_status"}],
        "offset": {"x": 900, "y": 1670}
      }
    },
    {
      "name": "msg_reactivation",
      "type": "send-and-wait-for-reply",
      "transitions": [
        {"next": "check_reactivation", "event": "incomingMessage"},
        {"next": "end_timeout", "event": "timeout"},
        {"next": "end_error", "event": "deliveryFailure"}
      ],
      "properties": {
        "offset": {"x": 1490, "y": 1070},
        "from": "{{flow.channel.address}}",
        "body": "üëã Salut {{widgets.http_check_user.parsed.name}} !\n\nTu t'√©tais d√©sinscrit(e) de BRACONGO FOOT.\n\nTu veux te r√©inscrire pour participer aux jeux et gagner des cadeaux ? üéÅ\n\n‚ö†Ô∏è Confirme :\n‚úÖ 18 ans ou plus\n‚úÖ Tu acceptes nos messages\n\nüëâ Tape OUI pour revenir\nüëâ Tape NON pour rester d√©sinscrit",
        "timeout": "3600"
      }
    },
    {
      "name": "check_reactivation",
      "type": "split-based-on",
      "transitions": [
        {"next": "msg_reste_stop", "event": "noMatch"},
        {"next": "http_log_reactivate", "event": "match", "conditions": [
          {"friendly_name": "OUI r√©activation", "arguments": ["{{widgets.msg_reactivation.inbound.Body}}"], "type": "matches_any_of", "value": "OUI,oui,Oui,O,o,YES,yes,Yes,OK,ok,Ok,1"}
        ]},
        {"next": "msg_reste_stop", "event": "match", "conditions": [
          {"friendly_name": "NON reste stop", "arguments": ["{{widgets.msg_reactivation.inbound.Body}}"], "type": "matches_any_of", "value": "NON,non,Non,N,n,NO,no,No,0,STOP,stop,Stop"}
        ]}
      ],
      "properties": {
        "input": "{{widgets.msg_reactivation.inbound.Body}}",
        "offset": {"x": 1290, "y": 1410}
      }
    },
    {
      "name": "http_log_reactivate",
      "type": "make-http-request",
      "transitions": [
        {"next": "msg_reactivation_ok", "event": "success"},
        {"next": "msg_reactivation_ok", "event": "failed"}
      ],
      "properties": {
        "offset": {"x": 1290, "y": 1660},
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\"phone\": \"{{flow.variables.phone_number}}\", \"status\": \"REACTIVATED\", \"timestamp\": \"{{flow.variables.timestamp}}\"}",
        "url": "https://can-wabracongo.ywcdigital.com/api/can/reactivate"
      }
    },
    {
      "name": "msg_reactivation_ok",
      "type": "send-message",
      "transitions": [
        {"next": "end_reactivated", "event": "sent"},
        {"next": "end_reactivated", "event": "failed"}
      ],
      "properties": {
        "offset": {"x": 1100, "y": 1950},
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "üéâ Content de te revoir {{widgets.http_check_user.parsed.name}} !\n\nTu es de retour dans la FAMILLE BRACONGO FOOT 2025 ! ü¶Å\n\nüîú On t'envoie bient√¥t :\n‚Üí Les Villages foot ndembo city pr√®s de chez toi\n‚Üí Les jeux pour gagner des cadeaux\n\nPr√©pare-toi ! üèÜ\n\nüìµ Tape STOP pour te d√©sinscrire\n\n#BracongoNaYo"
      }
    },
    {
      "name": "msg_reste_stop",
      "type": "send-message",
      "transitions": [
        {"next": "end_stop", "event": "sent"},
        {"next": "end_stop", "event": "failed"}
      ],
      "properties": {
        "offset": {"x": 1670, "y": 1670},
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "OK, pas de souci ! üëã\n\nTu restes d√©sinscrit(e).\n\nSi tu changes d'avis, envoie-nous un message.\n\nA BIENTOT ! ü¶Å"
      }
    },
    {
      "name": "http_log_scan",
      "type": "make-http-request",
      "transitions": [
        {"next": "msg_accueil", "event": "success"},
        {"next": "msg_accueil", "event": "failed"}
      ],
      "properties": {
        "offset": {"x": -400, "y": 1150},
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\"phone\": \"{{flow.variables.phone_number}}\", \"source_type\": \"{{flow.variables.source_type}}\", \"source_detail\": \"{{flow.variables.source_detail}}\", \"timestamp\": \"{{flow.variables.timestamp}}\", \"status\": \"SCAN\"}",
        "url": "https://can-wabracongo.ywcdigital.com/api/can/scan"
      }
    },
    {
      "name": "msg_accueil",
      "type": "send-and-wait-for-reply",
      "transitions": [
        {"next": "check_optin", "event": "incomingMessage"},
        {"next": "http_log_timeout", "event": "timeout"},
        {"next": "http_log_error", "event": "deliveryFailure"}
      ],
      "properties": {
        "offset": {"x": -400, "y": 1400},
        "from": "{{flow.channel.address}}",
        "body": "‚öΩBabiFoot by Solibra 2025\nAkwaba supporter !\nSolibra t'invite dans ses Villages babifoot city √† Abidjan !\n\nüéÅ Jeux, cadeaux & surprises t'attendent !\n\n‚ö†Ô∏è Pour continuer, confirme :\n‚úÖ Tu as 18 ans ou plus\n‚úÖ Tu acceptes nos messages\n\nüëâ Tape OUI pour t'inscrire",
        "timeout": "3600"
      }
    },
    {
      "name": "check_optin",
      "type": "split-based-on",
      "transitions": [
        {"next": "msg_relance_optin", "event": "noMatch"},
        {"next": "http_log_optin", "event": "match", "conditions": [
          {"friendly_name": "OUI accept√©", "arguments": ["{{widgets.msg_accueil.inbound.Body}}"], "type": "matches_any_of", "value": "OUI,oui,Oui,O,o,YES,yes,Yes,OK,ok,Ok,1"}
        ]},
        {"next": "http_log_refus", "event": "match", "conditions": [
          {"friendly_name": "NON refus√©", "arguments": ["{{widgets.msg_accueil.inbound.Body}}"], "type": "matches_any_of", "value": "NON,non,Non,N,n,NO,no,No,0"}
        ]},
        {"next": "http_log_stop", "event": "match", "conditions": [
          {"friendly_name": "STOP demand√©", "arguments": ["{{widgets.msg_accueil.inbound.Body}}"], "type": "matches_any_of", "value": "STOP,stop,Stop,ARRET,arret,Arret"}
        ]}
      ],
      "properties": {
        "input": "{{widgets.msg_accueil.inbound.Body}}",
        "offset": {"x": -400, "y": 1650}
      }
    },
    {
      "name": "msg_relance_optin",
      "type": "send-and-wait-for-reply",
      "transitions": [
        {"next": "check_optin_relance", "event": "incomingMessage"},
        {"next": "http_log_timeout", "event": "timeout"},
        {"next": "http_log_error", "event": "deliveryFailure"}
      ],
      "properties": {
        "offset": {"x": -900, "y": 1900},
        "from": "{{flow.channel.address}}",
        "body": "ü§î Je n'ai pas compris !\nPour t'inscrire √† SOLIBRA FOOT 2025 :\n\n‚úÖ Tu as 18 ans ou plus\n‚úÖ Tu acceptes nos messages\n\nüëâ Tape OUI pour confirmer\nüëâ Tape NON pour refuser",
        "timeout": "1800"
      }
    },
    {
      "name": "check_optin_relance",
      "type": "split-based-on",
      "transitions": [
        {"next": "http_log_abandon", "event": "noMatch"},
        {"next": "http_log_optin", "event": "match", "conditions": [
          {"friendly_name": "OUI accept√© relance", "arguments": ["{{widgets.msg_relance_optin.inbound.Body}}"], "type": "matches_any_of", "value": "OUI,oui,Oui,O,o,YES,yes,Yes,OK,ok,Ok,1"}
        ]},
        {"next": "http_log_refus", "event": "match", "conditions": [
          {"friendly_name": "NON refus√© relance", "arguments": ["{{widgets.msg_relance_optin.inbound.Body}}"], "type": "matches_any_of", "value": "NON,non,Non,N,n,NO,no,No,0,STOP,stop,Stop"}
        ]}
      ],
      "properties": {
        "input": "{{widgets.msg_relance_optin.inbound.Body}}",
        "offset": {"x": -900, "y": 2150}
      }
    },
    {
      "name": "http_log_optin",
      "type": "make-http-request",
      "transitions": [
        {"next": "msg_demande_nom", "event": "success"},
        {"next": "msg_demande_nom", "event": "failed"}
      ],
      "properties": {
        "offset": {"x": -400, "y": 1900},
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\"phone\": \"{{flow.variables.phone_number}}\", \"status\": \"OPTIN\", \"timestamp\": \"{{now | date: '%Y-%m-%d %H:%M:%S'}}\"}",
        "url": "https://can-wabracongo.ywcdigital.com/api/can/optin"
      }
    },
    {
      "name": "msg_demande_nom",
      "type": "send-and-wait-for-reply",
      "transitions": [
        {"next": "validate_nom", "event": "incomingMessage"},
        {"next": "http_log_timeout", "event": "timeout"},
        {"next": "http_log_error", "event": "deliveryFailure"}
      ],
      "properties": {
        "offset": {"x": -400, "y": 2150},
        "from": "{{flow.channel.address}}",
        "body": "Parfait ! ‚úÖ\n\nBienvenue dans la famille Solibra!\n\n Quel est ton nom ou pseudo ?",
        "timeout": "3600"
      }
    },
    {
      "name": "validate_nom",
      "type": "split-based-on",
      "transitions": [
        {"next": "set_nom", "event": "noMatch"},
        {"next": "msg_relance_nom", "event": "match", "conditions": [
          {"friendly_name": "Nom trop court", "arguments": ["{{widgets.msg_demande_nom.inbound.Body}}"], "type": "less_than", "value": "2"}
        ]},
        {"next": "http_log_stop", "event": "match", "conditions": [
          {"friendly_name": "Stop demand√©", "arguments": ["{{widgets.msg_demande_nom.inbound.Body}}"], "type": "matches_any_of", "value": "STOP,stop,Stop,ARRET,arret,Arret"}
        ]}
      ],
      "properties": {
        "input": "{{widgets.msg_demande_nom.inbound.Body}}",
        "offset": {"x": -400, "y": 2400}
      }
    },
    {
      "name": "msg_relance_nom",
      "type": "send-and-wait-for-reply",
      "transitions": [
        {"next": "set_nom_relance", "event": "incomingMessage"},
        {"next": "http_log_timeout", "event": "timeout"},
        {"next": "http_log_error", "event": "deliveryFailure"}
      ],
      "properties": {
        "offset": {"x": -900, "y": 2650},
        "from": "{{flow.channel.address}}",
        "body": "ü§î Donne-moi au moins 2 lettres !\n\nTon pr√©nom ou pseudo ?",
        "timeout": "1800"
      }
    },
    {
      "name": "set_nom_relance",
      "type": "set-variables",
      "transitions": [{"next": "msg_demande_boisson", "event": "next"}],
      "properties": {
        "variables": [{"value": "{{widgets.msg_relance_nom.inbound.Body | capitalize}}", "key": "user_name"}],
        "offset": {"x": -960, "y": 2900}
      }
    },
    {
      "name": "set_nom",
      "type": "set-variables",
      "transitions": [{"next": "msg_demande_boisson", "event": "next"}],
      "properties": {
        "variables": [{"value": "{{widgets.msg_demande_nom.inbound.Body | capitalize}}", "key": "user_name"}],
        "offset": {"x": -400, "y": 2650}
      }
    },
    {
      "name": "msg_demande_boisson",
      "type": "send-and-wait-for-reply",
      "transitions": [
        {"next": "validate_boisson", "event": "incomingMessage"},
        {"next": "http_log_inscription", "event": "timeout"},
        {"next": "http_log_error", "event": "deliveryFailure"}
      ],
      "properties": {
        "offset": {"x": -400, "y": 2900},
        "from": "{{flow.channel.address}}",
        "body": "Merci {{flow.variables.user_name}} ! üçπ\n\nQuelle est ta boisson pr√©f√©r√©e ?\n\n1. Bock\n2. 33 Export\n3. World Cola\n4. Coca Cola\n5. Fanta Orange\n6. Sprite\n7. Eau min√©rale\n8. Autre\n\nüëâ Tape le num√©ro (1-8)",
        "timeout": "1800"
      }
    },
    {
      "name": "validate_boisson",
      "type": "split-based-on",
      "transitions": [
        {"next": "msg_retry_boisson", "event": "noMatch"},
        {"next": "set_boisson_bock", "event": "match", "conditions": [
          {"friendly_name": "Choix 1 - Bock", "arguments": ["{{widgets.msg_demande_boisson.inbound.Body}}"], "type": "matches_any_of", "value": "1,BOCK,Bock,bock"}
        ]},
        {"next": "set_boisson_33export", "event": "match", "conditions": [
          {"friendly_name": "Choix 2 - 33 Export", "arguments": ["{{widgets.msg_demande_boisson.inbound.Body}}"], "type": "matches_any_of", "value": "2,33 EXPORT,33 Export,33export"}
        ]},
        {"next": "set_boisson_worldcola", "event": "match", "conditions": [
          {"friendly_name": "Choix 3 - World Cola", "arguments": ["{{widgets.msg_demande_boisson.inbound.Body}}"], "type": "matches_any_of", "value": "3,WORLD COLA,World Cola,worldcola"}
        ]},
        {"next": "set_boisson_coca", "event": "match", "conditions": [
          {"friendly_name": "Choix 4 - Coca Cola", "arguments": ["{{widgets.msg_demande_boisson.inbound.Body}}"], "type": "matches_any_of", "value": "4,COCA COLA,Coca Cola,coca"}
        ]},
        {"next": "set_boisson_fanta", "event": "match", "conditions": [
          {"friendly_name": "Choix 5 - Fanta", "arguments": ["{{widgets.msg_demande_boisson.inbound.Body}}"], "type": "matches_any_of", "value": "5,FANTA,Fanta Orange,fanta"}
        ]},
        {"next": "set_boisson_sprite", "event": "match", "conditions": [
          {"friendly_name": "Choix 6 - Sprite", "arguments": ["{{widgets.msg_demande_boisson.inbound.Body}}"], "type": "matches_any_of", "value": "6,SPRITE,Sprite,sprite"}
        ]},
        {"next": "set_boisson_eau", "event": "match", "conditions": [
          {"friendly_name": "Choix 7 - Eau", "arguments": ["{{widgets.msg_demande_boisson.inbound.Body}}"], "type": "matches_any_of", "value": "7,EAU,Eau,eau,Eau min√©rale"}
        ]},
        {"next": "set_boisson_autre", "event": "match", "conditions": [
          {"friendly_name": "Choix 8 - Autre", "arguments": ["{{widgets.msg_demande_boisson.inbound.Body}}"], "type": "matches_any_of", "value": "8,AUTRE,Autre,autre"}
        ]}
      ],
      "properties": {
        "input": "{{widgets.msg_demande_boisson.inbound.Body}}",
        "offset": {"x": -400, "y": 3150}
      }
    },
    {
      "name": "msg_retry_boisson",
      "type": "send-and-wait-for-reply",
      "transitions": [
        {"next": "validate_boisson", "event": "incomingMessage"},
        {"next": "http_log_inscription", "event": "timeout"}
      ],
      "properties": {
        "offset": {"x": -900, "y": 3400},
        "from": "{{flow.channel.address}}",
        "body": "‚ùå Choix invalide !\n\nüçπ Quelle est ta boisson pr√©f√©r√©e ?\n\n1. Bock\n2. 33 Export\n3. World Cola\n4. Coca Cola\n5. Fanta Orange\n6. Sprite\n7. Eau min√©rale\n8. Autre\n\nüëâ Tape le num√©ro (1-8)",
        "timeout": "1800"
      }
    },
    {
      "name": "set_boisson_bock",
      "type": "set-variables",
      "transitions": [{"next": "http_log_inscription", "event": "next"}],
      "properties": {
        "variables": [{"value": "Bock", "key": "boisson_preferee"}],
        "offset": {"x": -100, "y": 3400}
      }
    },
    {
      "name": "set_boisson_33export",
      "type": "set-variables",
      "transitions": [{"next": "http_log_inscription", "event": "next"}],
      "properties": {
        "variables": [{"value": "33 Export", "key": "boisson_preferee"}],
        "offset": {"x": 0, "y": 3400}
      }
    },
    {
      "name": "set_boisson_worldcola",
      "type": "set-variables",
      "transitions": [{"next": "http_log_inscription", "event": "next"}],
      "properties": {
        "variables": [{"value": "World Cola", "key": "boisson_preferee"}],
        "offset": {"x": 100, "y": 3400}
      }
    },
    {
      "name": "set_boisson_coca",
      "type": "set-variables",
      "transitions": [{"next": "http_log_inscription", "event": "next"}],
      "properties": {
        "variables": [{"value": "Coca Cola", "key": "boisson_preferee"}],
        "offset": {"x": 200, "y": 3400}
      }
    },
    {
      "name": "set_boisson_fanta",
      "type": "set-variables",
      "transitions": [{"next": "http_log_inscription", "event": "next"}],
      "properties": {
        "variables": [{"value": "Fanta Orange", "key": "boisson_preferee"}],
        "offset": {"x": 300, "y": 3400}
      }
    },
    {
      "name": "set_boisson_sprite",
      "type": "set-variables",
      "transitions": [{"next": "http_log_inscription", "event": "next"}],
      "properties": {
        "variables": [{"value": "Sprite", "key": "boisson_preferee"}],
        "offset": {"x": 400, "y": 3400}
      }
    },
    {
      "name": "set_boisson_eau",
      "type": "set-variables",
      "transitions": [{"next": "http_log_inscription", "event": "next"}],
      "properties": {
        "variables": [{"value": "Eau min√©rale", "key": "boisson_preferee"}],
        "offset": {"x": 500, "y": 3400}
      }
    },
    {
      "name": "set_boisson_autre",
      "type": "set-variables",
      "transitions": [{"next": "http_log_inscription", "event": "next"}],
      "properties": {
        "variables": [{"value": "Autre", "key": "boisson_preferee"}],
        "offset": {"x": 600, "y": 3400}
      }
    },
    {
      "name": "http_log_inscription",
      "type": "make-http-request",
      "transitions": [
        {"next": "msg_confirmation", "event": "success"},
        {"next": "msg_confirmation", "event": "failed"}
      ],
      "properties": {
        "offset": {"x": -340, "y": 3650},
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\"phone\": \"{{flow.variables.phone_number}}\", \"name\": \"{{flow.variables.user_name}}\", \"boisson_preferee\": \"{{flow.variables.boisson_preferee}}\", \"source_type\": \"{{flow.variables.source_type}}\", \"source_detail\": \"{{flow.variables.source_detail}}\", \"status\": \"INSCRIT\", \"timestamp\": \"{{now | date: '%Y-%m-%d %H:%M:%S'}}\"}",
        "url": "https://can-wabracongo.ywcdigital.com/api/can/inscription"
      }
    },
    {
      "name": "msg_confirmation",
      "type": "send-message",
      "transitions": [
        {"next": "end_success", "event": "sent"},
        {"next": "end_success", "event": "failed"}
      ],
      "properties": {
        "offset": {"x": -400, "y": 3900},
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "‚úÖ C'est bon {{flow.variables.user_name}} !\n\nTu fais partie de la TEAM SOLIBRA BABIFOOT CITY 2025‚öΩ‚öΩ\n\nüçπ Ta boisson pr√©f√©r√©e : {{flow.variables.boisson_preferee}}\n\nüéÅ A Gagner :\nUn casier de Bock ou de World Cola\nPr√©pare-toi √† jouer et √† gagner !\n\n#BabiFootCity"
      }
    },
    {
      "name": "http_log_refus",
      "type": "make-http-request",
      "transitions": [
        {"next": "msg_refus", "event": "success"},
        {"next": "msg_refus", "event": "failed"}
      ],
      "properties": {
        "offset": {"x": 100, "y": 1900},
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\"phone\": \"{{flow.variables.phone_number}}\", \"status\": \"REFUS\", \"timestamp\": \"{{now | date: '%Y-%m-%d %H:%M:%S'}}\"}",
        "url": "https://can-wabracongo.ywcdigital.com/api/can/refus"
      }
    },
    {
      "name": "msg_refus",
      "type": "send-message",
      "transitions": [
        {"next": "end_refus", "event": "sent"},
        {"next": "end_refus", "event": "failed"}
      ],
      "properties": {
        "offset": {"x": 100, "y": 2150},
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "Pas de probl√®me ! üëã\n\nSi tu changes d'avis, reviens nous voir.\n\nAllez les El√©phants!"
      }
    },
    {
      "name": "http_log_stop",
      "type": "make-http-request",
      "transitions": [
        {"next": "msg_stop", "event": "success"},
        {"next": "msg_stop", "event": "failed"}
      ],
      "properties": {
        "offset": {"x": 740, "y": 230},
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\"phone\": \"{{flow.variables.phone_number}}\", \"status\": \"STOP\", \"timestamp\": \"{{now | date: '%Y-%m-%d %H:%M:%S'}}\"}",
        "url": "https://can-wabracongo.ywcdigital.com/api/can/stop"
      }
    },
    {
      "name": "msg_stop",
      "type": "send-message",
      "transitions": [
        {"next": "end_stop", "event": "sent"},
        {"next": "end_stop", "event": "failed"}
      ],
      "properties": {
        "offset": {"x": 390, "y": 470},
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "‚úÖ C'est not√©.\n\nTu es d√©sinscrit(e) et ne recevras plus de messages de Solibra FOOT.\n\n A Bient√¥t  !"
      }
    },
    {
      "name": "http_log_abandon",
      "type": "make-http-request",
      "transitions": [
        {"next": "msg_abandon", "event": "success"},
        {"next": "msg_abandon", "event": "failed"}
      ],
      "properties": {
        "offset": {"x": -1300, "y": 2400},
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\"phone\": \"{{flow.variables.phone_number}}\", \"status\": \"ABANDON\", \"timestamp\": \"{{now | date: '%Y-%m-%d %H:%M:%S'}}\"}",
        "url": "https://can-wabracongo.ywcdigital.com/api/can/abandon"
      }
    },
    {
      "name": "msg_abandon",
      "type": "send-message",
      "transitions": [
        {"next": "end_abandon", "event": "sent"},
        {"next": "end_abandon", "event": "failed"}
      ],
      "properties": {
        "offset": {"x": -1300, "y": 2650},
        "from": "{{flow.channel.address}}",
        "to": "{{contact.channel.address}}",
        "body": "Pas de probl√®me ! üëã\n\nSi tu veux t'inscrire plus tard, envoie juste OUI.\n\nAllez les L√©opards ! ü¶Å"
      }
    },
    {
      "name": "http_log_timeout",
      "type": "make-http-request",
      "transitions": [
        {"next": "end_timeout", "event": "success"},
        {"next": "end_timeout", "event": "failed"}
      ],
      "properties": {
        "offset": {"x": -1300, "y": 1400},
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\"phone\": \"{{flow.variables.phone_number}}\", \"status\": \"TIMEOUT\", \"timestamp\": \"{{now | date: '%Y-%m-%d %H:%M:%S'}}\"}",
        "url": "https://can-wabracongo.ywcdigital.com/api/can/timeout"
      }
    },
    {
      "name": "http_log_error",
      "type": "make-http-request",
      "transitions": [
        {"next": "end_error", "event": "success"},
        {"next": "end_error", "event": "failed"}
      ],
      "properties": {
        "offset": {"x": -1300, "y": 1650},
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\"phone\": \"{{flow.variables.phone_number}}\", \"status\": \"ERROR\", \"timestamp\": \"{{now | date: '%Y-%m-%d %H:%M:%S'}}\"}",
        "url": "https://can-wabracongo.ywcdigital.com/api/can/error"
      }
    },
    {
      "name": "end_success",
      "type": "set-variables",
      "transitions": [],
      "properties": {
        "variables": [{"value": "INSCRIPTION_COMPLETE", "key": "flow_status"}],
        "offset": {"x": -400, "y": 4150}
      }
    },
    {
      "name": "end_deja_inscrit",
      "type": "set-variables",
      "transitions": [],
      "properties": {
        "variables": [{"value": "DEJA_INSCRIT", "key": "flow_status"}],
        "offset": {"x": 500, "y": 1470}
      }
    },
    {
      "name": "end_reactivated",
      "type": "set-variables",
      "transitions": [],
      "properties": {
        "variables": [{"value": "REACTIVATED", "key": "flow_status"}],
        "offset": {"x": 1100, "y": 2200}
      }
    },
    {
      "name": "end_refus",
      "type": "set-variables",
      "transitions": [],
      "properties": {
        "variables": [{"value": "REFUS", "key": "flow_status"}],
        "offset": {"x": 400, "y": 2450}
      }
    },
    {
      "name": "end_stop",
      "type": "set-variables",
      "transitions": [],
      "properties": {
        "variables": [{"value": "STOP", "key": "flow_status"}],
        "offset": {"x": 500, "y": 700}
      }
    },
    {
      "name": "end_abandon",
      "type": "set-variables",
      "transitions": [],
      "properties": {
        "variables": [{"value": "ABANDON", "key": "flow_status"}],
        "offset": {"x": -1300, "y": 2900}
      }
    },
    {
      "name": "end_timeout",
      "type": "set-variables",
      "transitions": [],
      "properties": {
        "variables": [{"value": "TIMEOUT", "key": "flow_status"}],
        "offset": {"x": -1500, "y": 1650}
      }
    },
    {
      "name": "end_error",
      "type": "set-variables",
      "transitions": [],
      "properties": {
        "variables": [{"value": "ERROR", "key": "flow_status"}],
        "offset": {"x": -1500, "y": 1900}
      }
    }
  ],
  "initial_state": "Trigger",
  "flags": {
    "allow_concurrent_calls": true
  }
}
